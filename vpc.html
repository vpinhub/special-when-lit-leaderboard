<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competition Scores</title>
    <link href="https://fonts.googleapis.com/css2?family=Encode+Sans&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Encode Sans', sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .competition-info {
            text-align: center;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .avatar {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }
        .score-details {
            flex: 1;
            text-align: left;
        }
        .score {
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
<div id="score-list"></div>

<script>
    async function fetchAndDisplayScores() {
        const scoreList = document.getElementById("score-list");
        try {
            // 1. Fetch data directly from the API
            const response = await fetch('https://virtualpinballchat.com:8443/vpc/api/v1/weeksByChannelName');
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const allChannelsData = await response.json();

            // 2. Find the "competition-corner" channel
            const competitionChannel = allChannelsData.find(channel => channel.channelName === "competition-corner");
            if (!competitionChannel) {
                throw new Error("Could not find the 'competition-corner' channel.");
            }

            // 3. Find the current week (where "isArchived" is false)
            const currentWeekData = competitionChannel.weeks.find(week => week.isArchived === false);
            if (!currentWeekData) {
                throw new Error("No active (unarchived) week found.");
            }
            
            // 4. Pass the filtered data to the display function
            updateScores(currentWeekData);

        } catch (error) {
            console.error("Error fetching or processing scores:", error);
            scoreList.innerHTML = `<p style="text-align:center; color:red;">Failed to load scores. Error: ${error.message}</p>`;
        }
    }

    // This function now takes the specific week's data directly
    function updateScores(weekData) {
        const scores = weekData.scores;
        const sortedScores = scores.sort((a, b) => b.score - a.score);

        const scoreList = document.getElementById("score-list");
        scoreList.innerHTML = ""; // Clear any previous items

        sortedScores.forEach(score => {
            const leaderboardItem = document.createElement("div");
            leaderboardItem.classList.add("leaderboard-item");
            leaderboardItem.innerHTML = `
                <img src="${score.userAvatarUrl}" alt="${score.username}'s avatar" class="avatar">
                <div class="score-details">
                    <div class="username">${score.username}</div>
                    <div class="score">${score.score.toLocaleString()}</div>
                </div>
            `;
            scoreList.appendChild(leaderboardItem);
        });
    }

    // Run the main function when the page loads
    fetchAndDisplayScores();
</script>

</body>
</html>
