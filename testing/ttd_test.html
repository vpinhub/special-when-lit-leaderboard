<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Encode+Sans&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Encode Sans', sans-serif; margin: 0; padding: 20px; }
        .leaderboard-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .avatar { border-radius: 50%; width: 50px; height: 50px; margin-right: 15px; object-fit: cover; background-color: #e0e0e0; }
        .score-details { flex: 1; text-align: left; min-width: 0; }
        .username { font-weight: 600; font-size: 16px; color: #333; }
        .score { font-weight: bold; font-size: 20px; color: black; }
    </style>
</head>
<body>
    <div id="leaderboard-container"></div>
    <script>
        const roomId = "700";
        const primaryUrl = `https://virtualpinballchat.com/vpc/api/v1/iscored?roomId=${roomId}`;
        const backupTarget = `https://iscored.info/roomCommands.php?c=getAllGamesAndScores&roomID=${roomId}`;
        const proxiedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(backupTarget)}`;
        const imageBaseUrl = "img/";

        async function fetchAndDisplayLeaderboard() {
            let data;
            try {
                const response = await fetch(primaryUrl);
                if (!response.ok) throw new Error("Primary failed");
                data = await response.json();
            } catch (error) {
                try {
                    const backupResponse = await fetch(proxiedUrl);
                    data = await backupResponse.json();
                } catch (backupError) {
                    document.getElementById("leaderboard-container").innerHTML = `<p>Failed to load scores.</p>`;
                    return;
                }
            }
            processData(data);
        }

        function processData(data) {
            const allScores = data.flatMap(game => game.scores.map(score => ({ name: score.name, score: score.score })));
            const playerHighScores = {};
            allScores.forEach(p => {
                const currentScore = parseInt(p.score, 10);
                if (!playerHighScores[p.name] || currentScore > playerHighScores[p.name].score) {
                    playerHighScores[p.name] = { name: p.name, score: currentScore };
                }
            });
            const sortedPlayers = Object.values(playerHighScores).sort((a, b) => b.score - a.score);
            buildLeaderboardView(sortedPlayers);
        }

        function buildLeaderboardView(players) {
            const container = document.getElementById("leaderboard-container");
            container.innerHTML = players.map(player => `
                <div class="leaderboard-item">
                    <img src="${imageBaseUrl}${player.name.toLowerCase().replace(/\s+/g, '_')}.gif" class="avatar" onerror="this.style.display='none'">
                    <div class="score-details">
                        <div class="username">${player.name}</div>
                        <div class="score">${player.score.toLocaleString()}</div>
                    </div>
                </div>`).join('');
        }
        document.addEventListener('DOMContentLoaded', fetchAndDisplayLeaderboard);
    </script>
</body>
</html>
